<%- include('../layouts/header.ejs') -%>
    <style>
        .full-width {
            width: 100%;
            height: 100%;
        }
    </style>

    <div class="screen-overlay"></div>
    <aside class="navbar-aside" id="offcanvas_aside">
        <div class="aside-top">
            <a href="index.html" class="brand-wrap">
                <img src="assets/imgs/theme/icons/homelogo.jpeg" class="logo" alt="BookStore"
                    style=" margin-left: 15px;">
                <h2 style="font-size: 23px;margin-top: -38px; padding-bottom: 10px; margin-left: 12px;">BookStore</h2>
            </a>
            <div>
                <button class="btn btn-icon btn-aside-minimize"> <i class="text-muted material-icons md-menu_open"></i>
                </button>
            </div>
        </div>
        <nav>
            <ul class="menu-aside">
                <li class="menu-item active">
                    <a class="menu-link" href="/admin/home"> <i class="icon material-icons md-home"></i>
                        <span class="text">Dashboard</span>
                    </a>
                </li>
                <li class="menu-item has-submenu">
                    <a class="menu-link" href="/admin/products"> <i class="icon material-icons md-shopping_bag"></i>
                        <span class="text">Products</span>
                    </a>
                    <div class="submenu">
                        <a href="/admin/products">Product List</a>
                        <!-- <a href="page-products-grid.html">Product grid</a> -->
                        <!-- <a href="page-products-grid-2.html">Product grid 2</a> -->
                    </div>
                </li>
                <li class="menu-item has-submenu">
                    <a class="menu-link" href="/admin/category"> <i class="icon material-icons md-shopping_bag"></i>
                        <span class="text">Categories</span>
                    </a>
                    <div class="submenu">
                        <a href="/admin/category">Category List</a>
                    </div>
                </li>
                <li class="menu-item has-submenu">
                    <a class="menu-link" href="page-orders-1.html"> <i class="icon material-icons md-shopping_cart"></i>
                        <span class="text">Orders</span>
                    </a>
                    <div class="submenu">
                        <a href="/admin/order">Order List</a>
                    </div>
                </li>
                <li class="menu-item has-submenu">
                    <a class="menu-link" href="page-sellers-cards.html"> <i class="icon material-icons md-store"></i>
                        <span class="text">Sellers</span>
                    </a>
                    <div class="submenu">
                        <!-- <a href="page-sellers-cards.html">Sellers cards</a> -->
                        <a href="/admin/users">Sellers list</a>
                        <!-- <a href="page-seller-detail.html">Seller profile</a> -->
                    </div>
                </li>
                <li class="menu-item has-submenu">
                    <a class="menu-link" href="page-transactions-1.html"> <i
                            class="icon material-icons md-monetization_on"></i>
                        <span class="text">Coupen</span>
                    </a>
                    <div class="submenu">
                        <a href="/admin/coupon">Coupen Management</a>
                        <!-- <a href="page-transactions-2.html">Transaction 2</a> -->
                    </div>
                </li>
                <li class="menu-item has-submenu">
                    <a class="menu-link" href="#"> <i class="icon material-icons md-person"></i>
                        <span class="text">Offer</span>
                    </a>
                    <div class="submenu">
                        <a href="/admin/offer">Offer Management</a>

                    </div>
                </li>
                <li class="menu-item">
                    <a class="menu-link" href="/admin/banner"> <i class="icon material-icons md-comment"></i>
                        <span class="text">Banner</span>
                    </a>
                </li>
            </ul>
            <hr>
            <ul class="menu-aside">

                <li class="menu-item">
                    <a class="menu-link" href="/admin/logout"> <i class="icon material-icons md-person"></i>
                        <span class="text"> Logout </span>
                    </a>
                </li>
            </ul>
            <br>
            <br>
        </nav>
    </aside>
    <main class="main-wrap">
        <header class="main-header navbar">
            <div class="col-search">

            </div>
            <div class="col-nav">
                <button class="btn btn-icon btn-mobile me-auto" data-trigger="#offcanvas_aside"> <i
                        class="material-icons md-apps"></i> </button>
                <ul class="nav">

                    <li class="nav-item">
                        <a class="nav-link btn-icon darkmode" href="#"> <i class="material-icons md-nights_stay"></i>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="requestfullscreen nav-link btn-icon"><i
                                class="material-icons md-cast"></i></a>
                    </li>

                    <li class="dropdown nav-item">
                        <a href="#" aria-expanded="false"> <img class="img-xs rounded-circle"
                                src="/admin-assets/imgs/people/avatar2.jpg" alt="User"></a>

                    </li>
                </ul>
            </div>
        </header>
        <section class="content-main">
            <div class="content-header">
                <div>
                    <h2 class="content-title card-title">Report</h2>
                </div>
                <div>
                    <a href="/admin/report" class="btn btn-sm btn-primary">All Dates</a>
                    <br><br>
                    <div class="filter-options mb-3">
                        <a href="/admin/report?filter=day" class="btn btn-sm btn-primary">Day</a>
                        <a href="/admin/report?filter=week" class="btn btn-sm btn-primary">Week</a>
                        <a href="/admin/report?filter=month" class="btn btn-sm btn-primary">Month</a>
                        <a href="/admin/report?filter=year" class="btn btn-sm btn-primary">Year</a>

                    </div>

                    <a href="#" onclick="downloadFile()" class="btn btn-primary btn-sm rounded"><i
                            class="icon material-icons md-print"></i>Print Report</a>
                    <!-- <a href="/admin/download-pdf" class="btn btn-primary btn-sm rounded"><i class="icon material-icons md-print"></i>Download PDF Report</a> -->
                    <button onclick="generateExcel()" class="btn btn-primary btn-sm rounded">Generate Excel</button>


                </div>

            </div>

            <div class="row">
                <div class="col-lg-2 mb-4">
                    <div class="card card-body">
                        <article class="icontext">
                            <div class="text">
                                <h6 class="mb-1 card-title"></h6>
                                <span>
                                    <%=orderCount%>
                                </span>
                                <span class="text-sm">Total Number of Orders</span>
                                <span>
                                    <%=totalDeliveredProducts%>
                                </span>
                                <span class="text-sm">Total Number of Products</span>
                            </div>
                        </article>
                    </div>
                </div>

                <div class="col-lg-2 mb-4">
                    <div class="card card-body">
                        <article class="icontext">
                            <div class="text">
                                <h6 class="mb-1 card-title"></h6>
                                <span>
                                    <%=paypalCount%>
                                </span>
                                <span class="text-sm">Online Payment</span>
                            </div>
                        </article>
                    </div>
                </div>
                <div class="col-lg-2 mb-4">
                    <div class="card card-body">
                        <article class="icontext">
                            <div class="text">
                                <h6 class="mb-1 card-title"></h6>
                                <span>
                                    <%=codCount%>
                                </span>
                                <span class="text-sm">Cash On Delivery</span>
                            </div>
                        </article>
                    </div>
                </div>
                <div class="col-lg-2 mb-4">
                    <div class="card card-body">
                        <article class="icontext">
                            <div class="text">
                                <h6 class="mb-1 card-title"></h6>
                                <span>
                                    <%=walletCount%>
                                </span>
                                <span class="text-sm">Wallet</span>
                            </div>
                        </article>
                    </div>
                </div>
                <div class="col-lg-2 mb-4">
                    <div class="card card-body">
                        <article class="icontext">
                            <div class="text">
                                <h6 class="mb-1 card-title"></h6>
                                <span>₹<%=totalAmount%></span>
                                <span class="text-sm">Total Amount</span>
                            </div>
                        </article>
                    </div>
                </div>

                <div class="col-lg-2 mb-4">
                    <div class="card card-body">
                        <article class="icontext">
                            <div class="text">
                                <h6 class="mb-1 card-title"></h6>
                                <span>₹<%=totalDiscount%></span>
                                <span class="text-sm">Total Discount</span>
                            </div>
                        </article>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <header class="card-header">
                    <form action="/admin/report" id="DateForm" method="GET">
                        <div class="row align-items-center">
                            <div class="col-md-3 col-12 me-auto mb-md-0 mb-3">
                                <select class="form-select" name="sorting">
                                    <% if (SortedData==='All Dates' ) { %>
                                        <option selected>All Dates</option>
                                        <option>wallet</option>
                                        <option>Cash on delevery</option>
                                        <option>paypal</option>
                                        <% } else if (SortedData==='wallet' ) { %>
                                            <option selected>
                                                <%=SortedData%>
                                            </option>
                                            <option>Cash on delevery</option>
                                            <option>paypal</option>
                                            <% } else if (SortedData==='Cash on delevery' ) { %>
                                                <option selected>
                                                    <%=SortedData%>
                                                </option>
                                                <option>wallet</option>
                                                <option>paypal</option>
                                                <% } else if (SortedData==='paypal' ) { %>
                                                    <option selected>
                                                        <%=SortedData%>
                                                    </option>
                                                    <option>wallet</option>
                                                    <option>Cash on delevery</option>
                                                    <% } else { %>
                                                        <option selected>All Dates</option>
                                                        <option>wallet</option>
                                                        <option>Cash on delevery</option>
                                                        <option>paypal</option>
                                                        <% } %>
                                </select>
                            </div>
                            <div class="col-md-2 col-6">
                                <button type="submit" id="submitButton1" class="btn btn-primary">Submit</button>
                            </div>
                            <%if(startDate && endDate){%>
                                <div class="col-md-2 col-6">
                                    <input type="date" id="startDateInput" value="<%=startDate%>" name="startDateInput"
                                        class="form-control">
                                </div>
                                <div class="col-md-2 col-6">
                                    <input type="date" id="endDateInput" value="<%=endDate%>" name="endDateInput"
                                        class="form-control">

                                </div>
                                <%}else{%>
                                    <div class="col-md-2 col-6">
                                        <input type="date" id="startDateInput" name="startDateInput"
                                            class="form-control">
                                    </div>
                                    <div class="col-md-2 col-6">
                                        <input type="date" id="endDateInput" name="endDateInput" class="form-control">
                                    </div>
                                    <%}%>
                                        <div class="col-md-2 col-6">
                                            <button id="submitButton" type="button" class="btn btn-primary"
                                                onclick="validateButton()" style="display: none;">Submit</button>
                                        </div>
                                        <div class="d-flex justify-content-center ">
                                            <div id="dateError" class="error text-center"
                                                style="color: red; display: none;">Your error message</div>
                                        </div>
                        </div>
                    </form>

                </header>

                <% if (orderData && orderData.length>0) { %>
                    <div class="card-body">

                        <% if (orderData.length> 0) { %>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Product ID</th>
                                        <th>Product Name</th>
                                        <th>Price</th>
                                        <th>Offer Percentage</th>
                                        <th>Offer Price</th>
                                        <th>Quantity</th>
                                        <th>Final Price</th>
                                        <th>Payment Method</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% for (let i=0; i < orderData.length; i++) { %>
                                        <% for (let j=0; j < orderData[i].items.length; j++) { %>
                                            <% if (orderData[i].currentData>= filterStartDate &&
                                                orderData[i].currentData <= filterEndDate) { %>

                                                    <tr>
                                                        <td># <%= orderData[i].items[j].productId._id %>
                                                        </td>
                                                        <td>
                                                            <%= orderData[i].items[j].productId.name %>
                                                        </td>
                                                        <td>
                                                            <%= orderData[i].items[j].productId.price %>.00
                                                        </td>


                                                        <td>
                                                            <% var offer=orderData[i].items[j].offer; %>
                                                                <% var offerPercentage=offer ? offer.percentage : 0; %>
                                                                    <%= offerPercentage %>%
                                                        </td>
                                                        <td>
                                                            <% var productId=orderData[i].items[j].productId; %>
                                                                <% var offer=orderData[i].items[j].offer; %>
                                                                    <% var quantity=orderData[i].items[j].quantity; %>

                                                                        <% var productPrice=productId.price; %>
                                                                            <% var offerPercentage=offer ?
                                                                                offer.percentage : 0; %>

                                                                                <% var discountedPrice=productPrice * (1
                                                                                    - offerPercentage / 100); %>
                                                                                    ₹<%= discountedPrice %>
                                                        </td>

                                                        <td>
                                                            <%= orderData[i].items[j].quantity %>
                                                        </td>

                                                        <td>
                                                            <% var productId=orderData[i].items[j].productId; %>
                                                                <% var offer=orderData[i].items[j].offer; %>
                                                                    <% var quantity=orderData[i].items[j].quantity; %>

                                                                        <% var productPrice=productId.price; %>
                                                                            <% var offerPercentage=offer ?
                                                                                offer.percentage : 0; %>

                                                                                <% var discountedPrice=productPrice * (1
                                                                                    - offerPercentage / 100); %>
                                                                                    <% var totalPrice=discountedPrice *
                                                                                        quantity; %>
                                                                                        ₹<%= totalPrice %>

                                                        </td>
                                                        <td>
                                                            <%= orderData[i].paymentMethod %>
                                                        </td>
                                                        <td>
                                                            <%= orderData[i].items[j].status %>
                                                        </td>
                                                        <td>
                                                            <%= orderData[i].currentData.toLocaleDateString() %>
                                                        </td>
                                                        <td>
                                                            <a href="/admin/vieworders?id=<%= orderData[i]._id %>&productId=<%= orderData[i].items[j].productId._id %>"
                                                                class="btn btn-sm font-sm rounded btn-brand">
                                                                View
                                                            </a>
                                                        </td>
                                                    </tr>
                                                    <% } %>
                                                        <% } %>
                                                            <% } %>
                                </tbody>
                            </table>
                            <% } else { %>
                                <div class="text-center custom-margin">
                                    <img src="/admin-assets/imgs/icons/nodata.jpg" class="img-fluid small-image"
                                        alt="Evara Dashboard">
                                </div>
                                <% } %>

                                    <% }else{ %>
                                        <div class="text-center custom-margin">
                                            <img src="/admin-assets/imgs/icons/nodata.jpg" class="img-fluid small-image"
                                                alt="Evara Dashboard">
                                        </div>
                                        <%}%>
                    </div>

            </div>
        </section>
        <footer class="main-footer font-xs">
            <div class="row pb-30 pt-15">
                <div class="col-sm-6">
                    <script>
                        document.write(new Date().getFullYear())
                    </script> ©, BookStore - online book shop .
                </div>
                <div class="col-sm-6">
                    <div class="text-sm-end">
                        All rights reserved
                    </div>
                </div>
            </div>
        </footer>
    </main>
    <script src="/admin-assets/js/vendors/jquery-3.6.0.min.js"></script>
    <script src="/admin-assets/js/vendors/bootstrap.bundle.min.js"></script>
    <script src="/admin-assets/js/vendors/select2.min.js"></script>
    <script src="/admin-assets/js/vendors/perfect-scrollbar.js"></script>
    <script src="/admin-assets/js/vendors/jquery.fullscreen.min.js"></script>
    <script src="/admin-assets/js/vendors/chart.js"></script>
    <!-- Main Script -->
    <script src="/admin-assets/js/main.js" type="text/javascript"></script>
    <script src="/admin-assets/js/custom-chart.js" type="text/javascript"></script>
    <script>
        function downloadFile() {
            window.print();
        }
    </script>
    <script>
        let startDateInput = document.getElementById('startDateInput');
        let endDateInput = document.getElementById('endDateInput');
        let submitButton = document.getElementById('submitButton');
        let dateError = document.getElementById('dateError')
        let submitButton1 = document.getElementById('submitButton1');

        function checkBothDatesSelected() {
            if (startDateInput.value && endDateInput.value) {
                submitButton.style.display = 'block';
                submitButton1.style.display = 'none';
            } else {
                submitButton.style.display = 'none';
            }
        }

        startDateInput.addEventListener('change', checkBothDatesSelected);
        endDateInput.addEventListener('change', checkBothDatesSelected);

        function validateButton() {
            if (startDateInput.value <= endDateInput.value) {
                dateError.style.display = 'none'
                const dateform = document.getElementById('DateForm')
                dateform.submit()
            } else {
                dateError.innerText = 'End Date should not be greaterthan Start Date';
                dateError.style.display = 'block'

            }
        }

    </script>

    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script> -->

    <!-- <script>
    function generateExcel() {
        // Create a new workbook
        var workbook = XLSX.utils.book_new();

        

        // Collect data from the HTML table
        var tableRows = document.querySelectorAll(".table tbody tr");
        var excelData = [];

        // Format data
        tableRows.forEach(function(row) {
            var rowData = [];
            rowData.push(row.querySelector("td:nth-child(1)").innerText.trim()); // Product ID
            rowData.push(row.querySelector("td:nth-child(2)").innerText.trim()); // Product Name
            rowData.push(row.querySelector("td:nth-child(3)").innerText.trim()); // Price
            rowData.push(row.querySelector("td:nth-child(4)").innerText.trim()); // Offer Percentage
            rowData.push(row.querySelector("td:nth-child(5)").innerText.trim()); // Offer Price
            rowData.push(row.querySelector("td:nth-child(6)").innerText.trim()); // Quantity
            rowData.push(row.querySelector("td:nth-child(7)").innerText.trim()); // Final Price
            rowData.push(row.querySelector("td:nth-child(8)").innerText.trim()); // Payment Method
            rowData.push(row.querySelector("td:nth-child(9)").innerText.trim()); // Status
            rowData.push(row.querySelector("td:nth-child(10)").innerText.trim()); // Date
            excelData.push(rowData);
        });

        // Define worksheet columns
        var headers = ["Product ID", "Product Name", "Price", "Offer Percentage", "Offer Price", "Quantity", "Final Price", "Payment Method", "Status", "Date"];
        
        // Add worksheet to the workbook
        var worksheet = XLSX.utils.aoa_to_sheet([headers].concat(excelData));
        XLSX.utils.book_append_sheet(workbook, worksheet, "Report");

        // Generate Excel file
        var excelBuffer = XLSX.write(workbook, { bookType: "xlsx", type: "array" });

        // Convert buffer to Blob
        var blob = new Blob([excelBuffer], { type: "application/octet-stream" });

        // Create download link
        var url = window.URL.createObjectURL(blob);
        var link = document.createElement("a");
        link.href = url;
        link.setAttribute("download", "report.xlsx");
        document.body.appendChild(link);

        // Trigger download
        link.click();

        // Cleanup
        document.body.removeChild(link);
    }
</script> -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.0/xlsx.full.min.js"></script>
    <script>
        function generateExcel() {
            var orderCountElement = document.querySelector(".col-lg-2:nth-child(1) .text span:nth-of-type(1)");
            var totalDeliveredProductsElement = document.querySelector(".col-lg-2:nth-child(1) .text span:nth-of-type(2)");
            var paypalCountElement = document.querySelector(".col-lg-2:nth-child(2) .text span");
            var codCountElement = document.querySelector(".col-lg-2:nth-child(3) .text span");
            var walletCountElement = document.querySelector(".col-lg-2:nth-child(4) .text span");
            var totalAmountElement = document.querySelector(".col-lg-2:nth-child(5) .text span:nth-of-type(1)");
            var totalDiscountElement = document.querySelector(".col-lg-2:nth-child(6) .text span:nth-of-type(1)");
            var startDateElement = document.getElementById('startDateInput');
            var endDateElement = document.getElementById('endDateInput');

            var orderCount = orderCountElement ? orderCountElement.textContent.trim() : '';
            var paypalCount = paypalCountElement ? paypalCountElement.textContent.trim() : '';
            var codCount = codCountElement ? codCountElement.textContent.trim() : '';
            var walletCount = walletCountElement ? walletCountElement.textContent.trim() : '';
            var totalAmount = totalAmountElement ? totalAmountElement.textContent.trim() : '';
            var totalDiscount = totalDiscountElement ? totalDiscountElement.textContent.trim() : '';
            var startDate = startDateElement ? startDateElement.value : '';
            var endDate = endDateElement ? endDateElement.value : '';

            var summaryData = [
                ["Order Count", orderCount],
                ["PayPal Count", paypalCount],
                ["Cash On Delivery Count", codCount],
                ["Wallet Count", walletCount],
                ["Total Amount", totalAmount],
                ["Total Discount", totalDiscount],
                ["Start Date", startDate],
                ["End Date", endDate]
            ];

            var tableRows = document.querySelectorAll(".table tbody tr");
            var excelData = [];

            tableRows.forEach(function (row) {
                var rowData = [];
                for (var i = 0; i < 10; i++) {
                    var cell = row.querySelector("td:nth-child(" + (i + 1) + ")");
                    rowData.push(cell ? cell.innerText.trim() : '');
                }
                excelData.push(rowData);
            });

            var headers = ["Product ID", "Product Name", "Price", "Offer Percentage", "Offer Price", "Quantity", "Final Price", "Payment Method", "Status", "Date"];

            var workbook = XLSX.utils.book_new();
            var worksheet1 = XLSX.utils.aoa_to_sheet(summaryData);
            var worksheet2 = XLSX.utils.aoa_to_sheet([headers].concat(excelData));
            XLSX.utils.book_append_sheet(workbook, worksheet1, "Summary");
            XLSX.utils.book_append_sheet(workbook, worksheet2, "Report");

            var excelBuffer = XLSX.write(workbook, { bookType: "xlsx", type: "array" });
            var blob = new Blob([excelBuffer], { type: "application/octet-stream" });
            var url = window.URL.createObjectURL(blob);
            var link = document.createElement("a");
            link.href = url;
            link.setAttribute("download", "report.xlsx");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>

    </body>


    <!-- Mirrored from wp.alithemes.com/html/evara/evara-backend/page-products-list.html by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 01 Aug 2021 15:33:12 GMT -->

    </html>